<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Prices Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        canvas {
            max-width: 80%;
            margin: 20px auto;
        }
        .autocomplete {
            position: relative;
            display: inline-block;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
    </style>
</head>
<body>
    <h1>Fuel Prices Dashboard</h1>
    <p>Select a site, department, and time range to view the graph:</p>
    <form id="filter-form">
        <div class="autocomplete">
            <label for="site-name">Site Name:</label>
            <input type="text" id="site-name" placeholder="Enter site name" required>
        </div>
        <div>
            <label for="department">Department:</label>
            <select id="department">
                <option value="1">Premium Unleaded</option>
                <option value="2">Unleaded</option>
                <option value="3">Ultimate</option>
                <option value="4">Diesel</option>
                <option value="5">LPG</option>
                <option value="6">Ad Blue</option>
                <option value="8">E85</option>
                <option value="10">E10</option>
                <option value="11">Low Aromatic</option>
            </select>
        </div>
        <div>
            <label for="date-range">Predefined Range:</label>
            <select id="date-range">
                <option value="hourly">Last Hour</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
            </select>
        </div>
        <button type="submit">Show Graph</button>
    </form>
    <canvas id="fuel-price-chart"></canvas>

    <script>
        const siteMappingsURL = "docs/site_mappings.json"; // URL to the mapping file
        const siteNameInput = document.getElementById("site-name");
        let siteMappings = {};

        // Fetch site mappings and initialize autocomplete
        fetch(siteMappingsURL)
            .then(response => response.json())
            .then(data => {
                siteMappings = data;
                initializeAutocomplete(siteNameInput, Object.values(siteMappings).map(site => site.name));
            })
            .catch(error => console.error("Error fetching site mappings:", error));

        function initializeAutocomplete(input, names) {
            let currentFocus;

            input.addEventListener("input", function () {
                const value = this.value;
                closeAllLists();

                if (!value) return false;
                currentFocus = -1;

                const listContainer = document.createElement("div");
                listContainer.setAttribute("id", this.id + "autocomplete-list");
                listContainer.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(listContainer);

                names.forEach(name => {
                    if (name.toLowerCase().includes(value.toLowerCase())) {
                        const item = document.createElement("div");
                        item.innerHTML = `<strong>${name.substr(0, value.length)}</strong>${name.substr(value.length)}`;
                        item.addEventListener("click", () => {
                            input.value = name;
                            closeAllLists();
                        });
                        listContainer.appendChild(item);
                    }
                });
            });

            input.addEventListener("keydown", function (e) {
                const list = document.getElementById(this.id + "autocomplete-list");
                if (list) var items = list.getElementsByTagName("div");
                if (e.keyCode === 40) { // Down key
                    currentFocus++;
                    addActive(items);
                } else if (e.keyCode === 38) { // Up key
                    currentFocus--;
                    addActive(items);
                } else if (e.keyCode === 13) { // Enter key
                    e.preventDefault();
                    if (currentFocus > -1 && items) items[currentFocus].click();
                }
            });

            function addActive(items) {
                if (!items) return false;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                items[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(items) {
                for (let item of items) item.classList.remove("autocomplete-active");
            }

            function closeAllLists(elmnt) {
                const lists = document.getElementsByClassName("autocomplete-items");
                for (let list of lists) {
                    if (elmnt != list && elmnt != input) list.parentNode.removeChild(list);
                }
            }

            document.addEventListener("click", e => closeAllLists(e.target));
        }

        document.getElementById("filter-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const siteName = siteNameInput.value;

            // Find site code by name
            const site = Object.entries(siteMappings).find(([code, details]) => details.name === siteName);

            if (!site) {
                alert("Site not found. Please select a valid site.");
                return;
            }

            const [siteCode] = site;
            console.log("Selected Site Code:", siteCode);

            // Add your graph generation logic here, using siteCode
        });
    </script>
</body>
</html>
